(author : Fernand Veilleux)
o<taper> sub
(CALL [#begin_x] [#end_x] [#begin_z] [#angle] [#finishing_passes])

	#<begin_x>          = #1
	#<end_x>            = #2
	#<begin_z>          = #3
	#<angle>            = #4
	#<finishing_passes> = #5
	
	o122 if [[#<angle> MOD 90] EQ 0]
		(debug,Taper: Invalid start/end position in X or Z)
		(print,)
		(print,Taper: Invalid start/end position in X or Z)
		(AXIS,notify,Taper: Invalid start/end position in X or Z)
		o<taper> return
	o122 endif

	o00 if [#<_lathe_diameter_mode> EQ 1]
		#<roughcut> = [#<_rough_cut> * 2]
		#<finishcut> = [#<_finish_cut> * 2]
		#<diff_x> = [[#<begin_x> - #<end_x>] / 2]
	o00 else
		#<roughcut> = #<_rough_cut>
		#<finishcut> = #<_finish_cut>
		#<diff_x> = [#<begin_x> - #<end_x>]
	o00 endif

	#<end_z> = [#<begin_z> - [#<diff_x> * TAN[90 - #<angle>]]]
	/ G0 X#<end_x> Z#<begin_z>
	/ F10
	/ G1 X#<begin_x> Z#<end_z>
	/ o<taper> return

	o997 if [#<begin_z> GT #<end_z>]
		o<in_list> CALL [#5413] [3] [0] [2] [9]
		o999 if [#<_in_list> EQ 0]
			(debug,Taper OD: Cutter orientation should be 2, 9 or None)
			(print,)
			(print,Taper OD: Cutter orientation should be 2, 9 or None)
			(AXIS,notify,Taper OD: Cutter orientation should be 2 or 9 or None)
;			o<taper> return
		o999 endif
	o997 else
		o<in_list> CALL [#5413] [3] [0] [1] [9]
		o998 if [#<_in_list> EQ 0]
			(debug,Taper OD: Cutter orientation should be 1, 9 or None)
			(print,)
			(print,Taper OD: Cutter orientation should be 1, 9 or None)
			(AXIS,notify,Taper OD: Cutter orientation should be 1 or 9 or None)
;			o<taper> return
		o998 endif
	o997 endif
	
	o10 if [#<finishing_passes> GT 0]
		#<cut_x_total> = [[#<begin_x> - #<end_x>] - #<finishcut>]
	o10 else
		#<cut_x_total> = [#<begin_x> - #<end_x>]
	o10 endif
	
	#<rough_passes> = FUP[#<cut_x_total> / #<roughcut>]
	o11 if [#<rough_passes> GT 0]
		#<x_step> = [#<cut_x_total> / #<rough_passes>]
	o11 elseif [#<rough_passes> LT 0]
;;		o<taper> return
	o11 endif

	#<rough_cut_z_total> = [#<cut_x_total> * SIN[90 - #<angle>] / SIN[#<angle>]]
	#<z_step> = [#<rough_cut_z_total> / #<rough_passes> / [#<_lathe_diameter_mode> + 1]]
	
	M#<_cooling_mode>
	
	o121 if [#<_tool_usage> LE 1]
		F#<_rough_feed>
		#<x> = #<begin_x>
		#<pass> = 1
		G0 Z[#<begin_z>]
		o12 repeat [#<rough_passes>]
			G0 X[#<x> + #<_x_clear>] Z[#<begin_z>]
			#<x> = [#<x> - #<x_step>]
			G0 X#<x>
			G0 Z[#<begin_z>]
			G1 X#<begin_x> Z[#<begin_z> - [#<z_step> * #<pass>]]
			G0 X[#<begin_x> + #<_x_clear>]
			#<pass> = [#<pass> + 1]
		o12 endrepeat
	o121 endif

	o20 if [#<finishing_passes> AND #<_tool_usage> NE 1]
		F#<_finish_feed>
		o21 repeat [#<finishing_passes>]
			G0 X[#<end_x> + #<_x_clear>] Z[#<begin_z>]
			G0 X#<end_x>
			G0 Z#<begin_z>
			G1 X#<begin_x> Z#<end_z>
			G1 X[#<begin_x> + #<_x_clear>]
		o21 endrepeat
	o20 endif
	
	M9 (cooling off)
	
	G0 X[#<_wp_dia_od> + #<_X_rapid>]
	
o<taper> endsub
